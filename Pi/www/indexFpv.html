<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html><head>
  <title></title>
</head>
<body style="color: rgb(0, 0, 0); background-color: rgb(153, 255, 153);">
    
<div style="position: absolute; top: 0px; left: 0px;"> <iframe id="cam1" src="" height="600" width="800"></iframe></div>
<div style="position: absolute; top: 0px; left: 800px;"> <iframe id="cam2" src="" height="600" width="800"></iframe></div>
    
    <div style="position: absolute; top: 0px; left: 200px;">
    <p id="error message"></p>
</div>
<div style="font-size: 24px; color:yellow; position: absolute; top: 100px; left: 400px;">
    <p id="message1"></p>
</div>
<div style="font-size: 24px; color:yellow; position: absolute; top: 140px; left: 200px;">
    <p id="message2"></p>
</div>
<div style="font-size: 24px; color:yellow; position: absolute; top: 160px; left: 200px;">
    <p id="message3"></p>
</div>
<div style="font-size: 24px; color:yellow; position: absolute; top: 180px; left: 200px;">
    <p id="message4"></p>
</div>
    
<form action="/cgi-bin/dfrobot.sh" method="POST">
    <button id="button-tilt" name="cmd" value="cam-move-abs.0"></button>
    <button id="button-forward" style="width: 100px; height: 100px; position: absolute; left: 150px; top: 30px; font-size: 32px; font-weight: bold; background-color: rgb(0, 255, 191);" name="cmd" value="drive.31"></button>
    <button id="button-left" style="width: 100px; height: 100px; position: absolute; left: 50px; top: 130px; font-size: 32px; font-weight: bold; background-color: rgb(0, 255, 191);" name="cmd" value="turn.-62"></button>
    <button id="button-right" style="width: 100px; height: 100px; position: absolute; left: 250px; top: 130px; font-size: 32px; font-weight: bold; background-color: rgb(0, 255, 191);" name="cmd" value="turn.62"></button>
    <button id="button-backward" style="width: 100px; height: 100px; position: absolute; left: 150px; top: 230px; font-size: 32px; font-weight: bold; background-color: rgb(0, 255, 191);" name="cmd" value="drive.-31"></button>
</form>

    
<script language="javascript" type="text/javascript">
// This script is executed each time after a page refresh, so then all variables are (re)created and initialized.
// The eventlisteners defined are called immediately after the event occurs.
// Below we generate the video stream url and the audio stream url.
// This url is deducted from the url of this page.
// The assumption is that the video stream port number is one higher and the audio stream port number two higher than the port number of this page.
var urlStr = document.URL; // url of this page.
urlStr = urlStr.replace(/[^\/]*$/, ""); // strip off indexFpv.html
var patt = /:([0-9]+)/; // regular expression to filter out the portnumber from the url.
if (patt.test(urlStr) == true) {
    // Execute the regular expression.
    // The result will contain the last matched characters in index 0 an the first parenthesized substring match in index 1.
    var res = patt.exec(urlStr);
    var portNumberPlusOne = (parseInt(res[1]) + 1).toString(); // the first parenthesized substring matches is in index 1
    var portNumberPlusTwo = (parseInt(res[1]) + 2).toString(); // the first parenthesized substring matches is in index 1
    var newUrlStrPlusOne = urlStr.replace(res[1],portNumberPlusOne);
    var newUrlStrPlusTwo = urlStr.replace(res[1],portNumberPlusTwo);
    document.getElementById("cam1").src = newUrlStrPlusOne + "stream_simple.html"; // url of the video stream page
    document.getElementById("cam2").src = newUrlStrPlusOne + "stream_simple.html"; // url of the video stream page
} else {
    //document.getElementById("error message").innerHTML = "cannot find video or audio stream url"; // write error message the to page
}

var previousDecoupledAlpha = 0; // For left - right motion.
var previousDecoupledGamma = 0; // For up - down motion.
var previousTime = 0;
var skip = false;
var delta = 100;
var decoupledAlpha = 0; // Decoupled here means decoupled from gamma, so no jump when gamma becomes negative.
var decoupledGamma = 0; // Decoupled here means no jump from +90 to -90 and range 0..180.
var cameraTilt = 0; // tilt of the camera, 0 .. 3.
var cameraPreviousTilt = 0; // tilt of the camera, 0 .. 3.
var fpvActive = false;
var firstTime = new Date().getTime();
function deviceOrientationHandler(event) {
    // Decouple alpha from gamma.
    if (event.gamma > 0.0) {
        decoupledAlpha = event.alpha < 180.0 ? event.alpha + 180.0 : event.alpha - 180.0;
    }
    else {
        decoupledAlpha = event.alpha;
    }
    // Decouple gamma which means remove jump ftom +90 to -90 and range 0..180
    decoupledGamma = event.gamma < 0.0 ? event.gamma + 180.0 : event.gamma;
    
    // Calculate the delta in the decoupled alpha since the previous measurement.
    var alphaDelta = decoupledAlpha - previousDecoupledAlpha;
    if (alphaDelta > 180) {
        alphaDelta = alphaDelta - 360;
    }
    else if (alphaDelta < -180) {
        alphaDelta = alphaDelta + 360
    }
    // Calculate the delta in the decoupled gamma since the previous measurement.
    var gammaDelta = decoupledGamma - previousDecoupledGamma;
    
    // Uncomment the three lines below for debugging.
    //document.getElementById("message1").innerHTML = event.alpha.toString();
    //document.getElementById("message2").innerHTML = event.beta.toString();
    //document.getElementById("message3").innerHTML = event.gamma.toString();
    // Measure once every delta milliseconds.
    // firstTime is used to only activate after 10 seconds after first entereing here (either by switching to FPV mode or a page refresh).
    // This to give the user the chance to put phone in the VR viewer.
    var n = new Date().getTime();
    if (n - firstTime > 10000 && n - previousTime > delta) {
        if (fpvActive == true) {
            // After a valid movement is measure skip will be set to true and delta to a higher value to give the user chance to move his head back.
            if (skip == false) {
                if (alphaDelta > 2.0) {
                    // valid left movement.
                    document.getElementById("message1").innerHTML = "left";
                    skip = true;
                    delta = 1000;
                    document.getElementById("button-left").click();
                }
                else if (alphaDelta < -2.0) {
                    // valid right movement.
                    document.getElementById("message1").innerHTML = "right";
                    skip = true;
                    delta = 1000;
                    document.getElementById("button-right").click();
                }
                else if (gammaDelta > 4.0) {
                    // valid down movement.
                    document.getElementById("message1").innerHTML = "down";
                    skip = true;
                    delta = 1000;
                    document.getElementById("button-backward").click();
                }
                else if (gammaDelta < -4.0) {
                    // valid up movement.
                    document.getElementById("message1").innerHTML = "up";
                    skip = true;
                    delta = 1000;
                    document.getElementById("button-forward").click();
                }
                else {
                    document.getElementById("message1").innerHTML = "active";
                    // No other movement is executed, so tilt camera if needed.
                    // Calculate the tilt to move the robot camera up and down.
                    // The tilt is only valid from horizontal position to 90 degrees upwards corresponding to 0 .. 3.
                    cameraTilt = Math.round(Math.round(Math.max(90 - decoupledGamma, 0)) / 10) * 10; // cameraTilt = 0,10,20...90
                    if (cameraTilt != cameraPreviousTilt) {
                        document.getElementById("button-tilt").value = "cam-move-abs." + cameraTilt.toString();
                        document.getElementById("button-tilt").click();
                        cameraPreviousTilt = cameraTilt;
                    }
                }
            }
            else {
                // User moved his head back, so back to normal operation.
                skip = false;
                delta = 100;
            }
        }
        else {
            document.getElementById("message1").innerHTML = "not active";
        }
        previousTime = n;
        previousDecoupledAlpha = decoupledAlpha;
        previousDecoupledGamma = decoupledGamma;        
    }
    else if (n - firstTime < 10000) {
        // Cout down.
        document.getElementById("message1").innerHTML = "countdown: " + Math.round(10 - (n - firstTime) / 1000);
        // Assign previous values until countdown is finished to prevent robot from moving immediately after countdown.
        previousTime = n;
        previousDecoupledAlpha = decoupledAlpha;
        previousDecoupledGamma = decoupledGamma;        
    }
    // fpvActive is used to activate FPV control. When the VR headset is facing downwards, fpvActive is false.
    fpvActive = !(Math.abs(event.gamma) < 45 && Math.abs(event.beta) < 90);
}

if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', deviceOrientationHandler, false);
}

</script>
    
</body></html>